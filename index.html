function tileToCoord(x, y, z) {
    let n = Math.PI - 2 * Math.PI * y / Math.pow(2, z);

    return [
        (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)))),
        (x / Math.pow(2, z) * 360 - 180)
    ];
}


$(document).ready(function () {
    let map = L.map('map').setView([0, 0], 2);

    L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> Contributors',
            maxZoom: 18,
        }).addTo(map);

    let markers = {};
    let polys = {};
    let cache_polys = [];

    function showData() {
        $.ajax({
            url: "/getplayers"
        }).done(function (data) {
            for (let player of data) {
                let marker = markers[player[0]] || L.marker([player[1], player[2]]).addTo(map);
                markers[player[0]] = marker;

                marker.setLatLng(new L.LatLng(player[1], player[2]));
            }
        })

        $.ajax({
            url: "/getchunks"
        }).done(function (data) {
            for (let chunk of data) {
                let s_id = chunk[0].toString() + ":" + chunk[1].toString();

                let x = chunk[0];
                let y = chunk[1];

                if (!(s_id in polys)) {
                    let polygon = L.polygon(tileToPoly(x, y), {
                        // stroke: false,
                        weight: 1,
                        color: "#00ff00",
                        fillOpacity: 0.2,
                    }).addTo(map);

                    polys[s_id] = polygon;
                }
            }
        })
    }

    setInterval(showData, 10000);
    showData();

    let totalArea = 0;

    require(["esri/geometry/support/geodesicUtils", "esri/geometry/Polygon"], function (geodesicUtils, Polygon) {
        $.ajax({
            url: "/cached"
        }).done(function (data) {
            for (let chunk of data) {

                let polygon = L.polygon(chunk, {
                    //stroke: false,
                    color: "#ffff00",
                    fillOpacity: 0.25,
                }).addTo(map);

                cache_polys.push(polygon);

                let rings = chunk;
                rings.push(rings[0]);

                let poly = new Polygon({
                    hazZ: false,
                    hasM: false,
                    "rings": rings,
                })

                totalArea += geodesicUtils.geodesicAreas([poly], "square-kilometers")[0];

            }

            console.log(totalArea);

            $("#totalareakm").text(Math.round(totalArea).toString());
            $("#totalareami").text(Math.round(totalArea * 0.386102).toString());

            $("#cacheinfo").removeClass("hidden");
            $("#cloading").remove();

        })

    })
})
